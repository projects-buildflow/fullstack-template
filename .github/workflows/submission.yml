name: Task Submission

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Job 1: Detect task and validate
  # ============================================
  setup:
    name: Setup & Validate
    runs-on: ubuntu-latest
    outputs:
      task_id: ${{ steps.detect.outputs.task_id }}
      week: ${{ steps.detect.outputs.week }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect task from branch name
        id: detect
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Branch: $BRANCH"

          # Extract task ID (e.g., "task-2.1" or "task-2.1-add-button" -> "2.1")
          TASK_ID=$(echo "$BRANCH" | grep -oP 'task-\K[0-9]+\.[0-9]+' || echo "")

          # Get week number
          WEEK=$(echo "$TASK_ID" | cut -d'.' -f1)

          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT
          echo "week=$WEEK" >> $GITHUB_OUTPUT

          echo "Detected: Task=$TASK_ID, Week=$WEEK"

      - name: Validate branch naming
        run: |
          BRANCH="${{ github.head_ref }}"
          if [[ ! "$BRANCH" =~ ^task-[0-9]+\.[0-9]+ ]]; then
            echo "::error::Invalid branch name format"
            echo "Expected: task-<week>.<task> or task-<week>.<task>-<description>"
            echo "Example: task-2.1 or task-2.1-add-button"
            exit 1
          fi

  # ============================================
  # Job 2: Linting
  # ============================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        id: eslint
        continue-on-error: true
        run: |
          npm run lint 2>&1 | tee lint-output.txt || echo "eslint_failed=true" >> $GITHUB_OUTPUT

      - name: Lint summary
        run: |
          if [[ "${{ steps.eslint.outputs.eslint_failed }}" == "true" ]]; then
            echo "::warning::Linting issues found. Please fix them."
            echo ""
            echo "To fix issues, run: npm run lint -- --fix"
            exit 1
          fi
          echo "Linting passed"

  # ============================================
  # Job 3: Run Tests
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: setup
    outputs:
      passed: ${{ steps.test.outputs.passed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run task tests
        id: test
        run: |
          TASK_ID="${{ needs.setup.outputs.task_id }}"

          # Convert task ID to test file name (2.1 -> task_2_1.test.ts or task_2_1.test.tsx)
          TEST_FILE_TS="__tests__/task_${TASK_ID//./_}.test.ts"
          TEST_FILE_TSX="__tests__/task_${TASK_ID//./_}.test.tsx"

          echo "Looking for test files: $TEST_FILE_TS or $TEST_FILE_TSX"

          if [ ! -f "$TEST_FILE_TS" ] && [ ! -f "$TEST_FILE_TSX" ]; then
            echo "No test file found for task $TASK_ID"
            echo "passed=skip" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine which test file exists
          if [ -f "$TEST_FILE_TS" ]; then
            TEST_FILE="$TEST_FILE_TS"
          else
            TEST_FILE="$TEST_FILE_TSX"
          fi

          echo "Running tests from: $TEST_FILE"

          # Run Vitest for specific test file, capture exit code
          set +e
          npm run test:run -- "$TEST_FILE" --reporter=verbose 2>&1 | tee test-output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          set -e

          # Always set the output before potentially failing
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ All tests passed!"
          else
            echo "passed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Some tests failed. Please fix them before merging."
          fi

          # Exit with the test result so the job properly fails
          exit $TEST_EXIT_CODE

      - name: Upload test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: test-output.txt
          if-no-files-found: ignore

  # ============================================
  # Job 4: Notify Backend (triggers AI review if needed)
  # ============================================
  notify:
    name: Notify Backend
    runs-on: ubuntu-latest
    needs: [setup, lint, test]
    if: always()

    steps:
      - name: Send results to backend
        env:
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          if [ -z "$BACKEND_URL" ]; then
            echo "BACKEND_URL not configured, skipping notification"
            exit 0
          fi

          # Determine overall status
          LINT_PASSED="${{ needs.lint.result == 'success' }}"
          TEST_PASSED="${{ needs.test.outputs.passed || 'skip' }}"

          curl -X POST "${BACKEND_URL}/webhooks/github" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${WEBHOOK_SECRET}" \
            -d '{
              "event": "pr_check_complete",
              "pr_number": ${{ github.event.pull_request.number }},
              "pr_url": "${{ github.event.pull_request.html_url }}",
              "task_id": "${{ needs.setup.outputs.task_id }}",
              "student_github": "${{ github.event.pull_request.user.login }}",
              "branch_name": "${{ github.head_ref }}",
              "lint_passed": '"$LINT_PASSED"',
              "test_passed": "'"$TEST_PASSED"'",
              "repo": "${{ github.repository }}",
              "track": "fullstack"
            }' || echo "Backend notification failed (non-fatal)"

          echo "Backend notified"

  # ============================================
  # Job 5: Auto-merge PR when all checks pass
  # ============================================
  auto-merge:
    name: Auto Merge
    runs-on: ubuntu-latest
    needs: [setup, lint, test]
    if: |
      needs.lint.result == 'success' &&
      (needs.test.outputs.passed == 'true' || needs.test.outputs.passed == 'skip')
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Approve and merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          TASK_ID=${{ needs.setup.outputs.task_id }}

          echo "‚úÖ All checks passed for Task ${TASK_ID}!"
          echo ""

          # Approve the PR
          echo "Approving PR #${PR_NUMBER}..."
          gh pr review ${PR_NUMBER} --approve --body "‚úÖ All checks passed! Auto-approved by BuildFlow."

          # Merge the PR with squash
          echo "Merging PR #${PR_NUMBER}..."
          gh pr merge ${PR_NUMBER} \
            --squash \
            --delete-branch \
            --body "üéâ Task ${TASK_ID} completed! Auto-merged by BuildFlow."

          echo ""
          echo "üéâ PR merged successfully!"
